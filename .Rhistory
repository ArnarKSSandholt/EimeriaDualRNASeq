i <- 0
while (i < length(cat_list)) {
i <- i + 1
cat_pval_up_df[,i] <- -log10(cat_list[[i]]$P.Up)
cat_pval_down_df[,i] <- -log10(cat_list[[i]]$P.Down)
}
i <- 0
while (i < dim(cat_pval_up_df)[1]) {
i <- i + 1
j <- 0
while (j < dim(cat_pval_up_df)[2]) {
j <- j + 1
if (cat_pval_up_df[i,j] >= cat_pval_down_df[i,j]) {
cat_pval_mix_df[i,j] <- cat_pval_up_df[i,j]
} else {
cat_pval_mix_df[i,j] <- -cat_pval_down_df[i,j]
}
}
}
return(list(cat_pval_up_df, cat_pval_down_df, cat_pval_mix_df))
}
remove_high_pval_rows <- function(pval_df, pval_thresh) {
pval_thresh <- -log10(pval_thresh)
i <- 1
while (i <= dim(pval_df)[1]) {
num_high_pval <- 0
j <- 0
while (j < dim(pval_df)[2]) {
j <- j + 1
if (pval_df[i,j] < pval_thresh) {
num_high_pval <- num_high_pval + 1
}
}
if (num_high_pval == j) {
pval_df <- pval_df[-i,]
} else {
i <- i + 1
}
}
return(pval_df)
}
go_chicken_pval_list <- create_cat_pval_df(go_chicken_list, go_chicken_list[[1]]$Term, timepoints)
kegg_chicken_pval_list <- create_cat_pval_df(kegg_chicken_list, kegg_chicken_list[[1]]$Pathway, timepoints)
go_chicken_pval_list_filtered <- lapply(go_chicken_pval_list, function(x) remove_high_pval_rows(x, fdr_threshold/10))
kegg_chicken_pval_list_filtered <- lapply(kegg_chicken_pval_list, function(x) remove_high_pval_rows(x, fdr_threshold))
heatmap_path <- "figures/heatmaps/GO_cat_upregulated.pdf"
pdf(heatmap_path, width = 60, height = 180, pointsize = 60)
aspectHeatmap(as.matrix(go_chicken_pval_list_filtered[[1]]), Colv = NA,
xlab = "Timepoints", main = "Upregulated GO categories",
hExp = 5, wExp = 0.8, col = colorRampPalette(brewer.pal(9, "YlOrRd"))(50))
dev.off()
heatmap_path <- "figures/heatmaps/GO_cat_downregulated.pdf"
pdf(heatmap_path, width = 140, height = 180, pointsize = 100)
aspectHeatmap(as.matrix(go_chicken_pval_list_filtered[[2]]), Colv = NA,
xlab = "Timepoints", main = "Downregulated GO categories",
hExp = 2, wExp = 0.7, col = colorRampPalette(brewer.pal(9, "YlOrRd"))(50))
dev.off()
col_breaks <- c(seq(-10,-3,length = 15), seq(-2.95, 2.95, length = 119), seq(3,10,length = 15))
col_palette <- colorRampPalette(c("red", "white", "blue"))(n = 148)
heatmap_path <- "figures/heatmaps/GO_cat_mixed.pdf"
pdf(heatmap_path, width = 110, height = 70, pointsize = 60)
heatmap.2(as.matrix(go_chicken_pval_list_filtered[[3]]), Colv = FALSE, dendrogram = "row", col = col_palette, breaks = col_breaks,
xlab = "Timepoints", main = "GO categories",cexRow=0.7,cexCol=1,margins=c(5,12),trace="none",srtCol=45,key = FALSE)
dev.off()
heatmap_path <- "figures/heatmaps/KEGG_cat_upregulated.pdf"
pdf(heatmap_path, width = 130, height = 120, pointsize = 120)
aspectHeatmap(as.matrix(kegg_chicken_pval_list_filtered[[1]]), Colv = NA,
xlab = "Timepoints", main = "Upregulated KEGG categories",
wExp = 0.7, col = colorRampPalette(brewer.pal(9, "YlOrRd"))(50))
dev.off()
heatmap_path <- "figures/heatmaps/KEGG_cat_downregulated.pdf"
pdf(heatmap_path, width = 100, height = 100, pointsize = 100)
aspectHeatmap(as.matrix(kegg_chicken_pval_list_filtered[[2]]), Colv = NA,
xlab = "Timepoints", main = "Downregulated KEGG categories",
hExp = 2, col = colorRampPalette(brewer.pal(9, "YlOrRd"))(50))
dev.off()
col_breaks <- c(seq(-10,-5,length = 11), seq(-4.95, 4.95, length = 199), seq(5,10,length = 11))
col_palette <- colorRampPalette(c("red", "white", "blue"))(n = 220)
heatmap_path <- "figures/heatmaps/KEGG_cat_mixed.pdf"
pdf(heatmap_path, width = 110, height = 70, pointsize = 100)
heatmap.2(as.matrix(kegg_chicken_pval_list_filtered[[3]]), Colv = FALSE, dendrogram = "row", col = col_palette, breaks = col_breaks,
xlab = "Timepoints", main = "KEGG categories",cexRow=0.7,cexCol=1,margins=c(5,12),trace="none",srtCol=45)
dev.off()
# Get a lsit of genes that belong to each GO category of interest
get_de_go_cat_genes <- function(de_gene_list, go_id, database_go, database_symbols) {
cat_genes <- unique(database_go$gene_id[database_go$go_id == go_id])
cat_gene_ids <- database_symbols[match(cat_genes, database_symbols$gene_id),]$symbol
cat_de_genes <- lapply(de_gene_list, function(x) x$table[cat_gene_ids,])
cat_de_genes <- lapply(cat_de_genes, function(x) x[complete.cases(x),])
return(cat_de_genes)
}
egGO <- toTable(org.Gg.egGO2ALLEGS)
egSYMBOL <- toTable(org.Gg.egSYMBOL)
cell_cell_signaling_by_wnt_gene_list <- get_de_go_cat_genes(topgenes_chicken_list, "GO:0198738", egGO, egSYMBOL)
# Get a list of genes that belong to each KEGG category of interest
get_de_kegg_cat_genes <- function(de_gene_list, organism_kegg_id, pathway_id, database_symbols) {
# For a given organism, list of differentially expressed genes in a set of experiments and
# KEGG pathway of interest, this function returns a list containing information on the DE of
# each gene in the pathway for this organism.
pathway_genes <- keggLink("pathway", organism_kegg_id) # Get all genes connected to KEGG pathways for this organism
cat_genes <- names(pathway_genes[pathway_genes == pathway_id]) # Get the names of genes connected to the pathway of interest
cat_genes <- sapply(cat_genes, function(x) substr(x, 5, nchar(x)))
cat_gene_ids <- database_symbols[match(cat_genes, database_symbols$gene_id),]$symbol
cat_de_genes <- lapply(de_gene_list, function(x) x$table[cat_gene_ids,])
cat_de_genes <- lapply(cat_de_genes, function(x) x[complete.cases(x),])
return(cat_de_genes)
}
toll_like_gene_list <- get_de_kegg_cat_genes(topgenes_chicken_list,"gga", "path:gga04620", egSYMBOL)
plot_de_cat_genes <- function(de_cat_genes, experimental_conditions, plot_title, fdr_thresh = 0.05,
logfc_thresh = 1, num_samples_fdr_thresh = 1, num_samples_logfc_thresh = 1,
cat_plot_path, plot_scale = c(-5,7.5)) {
# Produces a line plot of log2 fold change across a set of samples for genes in a specific
# GO or KEGG category
i <- 1
j <- 1
de_cat_gene_df <- as.data.frame(matrix(0,
ncol = dim(de_cat_genes[[1]])[2],
nrow = dim(de_cat_genes[[1]])[1]*length(de_cat_genes)))
colnames(de_cat_gene_df) <- colnames(de_cat_genes[[1]])
num_conditions <- length(de_cat_genes)
num_genes <- dim(de_cat_genes[[1]])[1]
while (i <= num_genes) {
k <- 1
while (k <= num_conditions) {
de_cat_gene_df[j,] <- de_cat_genes[[k]][i,]
j <- j + 1
k <- k + 1
}
i <- i + 1
}
below_fdr_threshold <- de_cat_gene_df$FDR < fdr_thresh
de_cat_gene_df$below_fdr_threshold <- below_fdr_threshold
curr_num_genes <- dim(de_cat_genes[[1]])[1]
neg_logfc_thresh <- -logfc_thresh
i <- 0
while (i < curr_num_genes) {
gene_start <- num_conditions*i + 1
gene_end <- num_conditions*(i + 1)
gene_below_thresh <- FALSE
j <- num_conditions*i + 1
num_samples_below_fdr_thresh = 0
num_samples_above_logfc_thresh = 0
while (j <= num_conditions*(i+1)) {
if (de_cat_gene_df$below_fdr_threshold[j]) {
num_samples_below_fdr_thresh <- num_samples_below_fdr_thresh + 1
}
if (de_cat_gene_df$logFC[j] >= logfc_thresh || de_cat_gene_df$logFC[j] <= neg_logfc_thresh) {
num_samples_above_logfc_thresh <- num_samples_above_logfc_thresh + 1
}
j <- j + 1
}
if (num_samples_below_fdr_thresh >= num_samples_fdr_thresh && num_samples_above_logfc_thresh >= num_samples_logfc_thresh) {
i <- i + 1
}
else {
gene_start <- num_conditions*i + 1
gene_end <- num_conditions*(i + 1)
de_cat_gene_df <- de_cat_gene_df[-c(gene_start:gene_end),]
}
curr_num_genes <- dim(de_cat_gene_df)[1]/num_conditions
}
if (curr_num_genes > 30) {
# To increase readability, the plot is split into two if there are too many genes being plotted
split_vec_1 <- rep(1, curr_num_genes/2)
split_vec_2 <- rep(2, curr_num_genes/2)
split_vec <- c(split_vec_1, split_vec_1, split_vec_1, split_vec_1, split_vec_1, split_vec_1,
split_vec_2, split_vec_2, split_vec_2, split_vec_2, split_vec_2, split_vec_2)
if (curr_num_genes*6 > length(split_vec)) {
split_vec <- c(split_vec, rep(2, num_conditions))
}
de_cat_gene_df_list <- split(de_cat_gene_df, split_vec)
de_cat_gene_df <- de_cat_gene_df_list[[1]]
curr_num_genes <- dim(de_cat_gene_df)[1]/num_conditions
de_cat_gene_df$gene_timepoints <- rep(experimental_conditions, curr_num_genes)
cat_plot_path <- gsub(".png", "_1.png", cat_plot_path)
png(cat_plot_path, width = 1200, height = 800)
p <- ggplot(de_cat_gene_df, aes(x=gene_timepoints, y=logFC, group=gene_name)) +
geom_line(aes(color = gene_name), size = 1.5) +
scale_color_manual(values = as.vector(polychrome(curr_num_genes))) +
geom_point(aes(shape=below_fdr_threshold, color = gene_name), size = 5) +
scale_shape_manual(values = c(1,17)) +
scale_x_discrete(limits=experimental_conditions) +
theme_bw() +
ggtitle(plot_title) +
theme(plot.title = element_text(hjust = 0.5, size = 36),
legend.title = element_text(size = 28),
legend.text = element_text(size = 20),
axis.text = element_text(size = 16),
axis.title = element_text(size = 24)) +
coord_cartesian(ylim = plot_scale, xlim = c(0, 80)) +
labs(shape = "Below FDR threshold", color = "Gene symbol") +
xlab("Sample time points") + ylab("log2(Fold change)") +
geom_hline(yintercept = 0)
print(p)
dev.off()
cat_plot_path <- gsub("_1.png", "_2.png", cat_plot_path)
de_cat_gene_df <- de_cat_gene_df_list[[2]]
curr_num_genes <- dim(de_cat_gene_df)[1]/num_conditions
}
de_cat_gene_df$gene_timepoints <- rep(experimental_conditions, curr_num_genes)
png(cat_plot_path, width = 1200, height = 800)
p <- ggplot(de_cat_gene_df, aes(x=gene_timepoints, y=logFC, group=gene_name)) +
geom_line(aes(color = gene_name), size = 1.5) +
scale_color_manual(values = as.vector(polychrome(curr_num_genes))) +
geom_point(aes(shape=below_fdr_threshold, color = gene_name), size = 5) +
scale_shape_manual(values = c(1,17)) +
scale_x_discrete(limits=experimental_conditions) +
theme_bw() +
ggtitle(plot_title) +
theme(plot.title = element_text(hjust = 0.5, size = 36),
legend.title = element_text(size = 28),
legend.text = element_text(size = 20),
axis.text = element_text(size = 16),
axis.title = element_text(size = 24)) +
coord_cartesian(ylim = plot_scale, xlim = c(0, 80)) +
labs(shape = "Below FDR threshold", color = "Gene symbol") +
xlab("Sample time points") + ylab("log2(Fold change)") +
geom_hline(yintercept = 0)
print(p)
dev.off()
}
# Plot a lineplot showing log fold change in each sample for the genes in the toll like KEGG pathway
plot_de_cat_genes(toll_like_gene_list, c(2,4,12,24,48,72), "Toll-like receptor signaling pathway gene expression", fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 1, num_samples_logfc_thresh = 1,
"figures/expression_line_plots/toll_like_receptor_plot.png")
tlr15_list <- lapply(topgenes_chicken_list, function(x) x$table["TLR15",])
tlr21_list <- lapply(topgenes_chicken_list, function(x) x$table["TLR21",])
plot_de_cat_genes(tlr15_list, c(2,4,12,24,48,72), "TLR15 expression", fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 0, num_samples_logfc_thresh = 0,
"figures/expression_line_plots/tlr15_expression.png")
plot_de_cat_genes(tlr21_list, c(2,4,12,24,48,72), "TLR21 expression", fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 0, num_samples_logfc_thresh = 0,
"figures/expression_line_plots/tlr21_expression.png")
path_to_immuno_gene_list <- "immune_classified_genes.csv"
immune_classified_genes <- read.delim(path_to_immuno_gene_list, check.names=FALSE, stringsAsFactors=FALSE)
immune_cats <- unique(immune_classified_genes$Category)
i <- 0
while (i < length(immune_cats)) {
i <- i + 1
cat_gene_ids <- immune_classified_genes[immune_cats[i] == immune_classified_genes$Category,]$entrez_gene_id
cat_gene_list <- lapply(topgenes_chicken_list, function(x) x$table[match(cat_gene_ids, x$table$entrez_gene_id),])
if (immune_cats[i] == "mannose rec") {
j <- 0
while (j < length(cat_gene_list)) {
j <- j + 1
rownames(cat_gene_list[[j]]) <- c("MRC1LC", "MRC1LD", "MRC1LE", "MRC1LB", "MRC1LA", "MRC2", "PLA2R1")
cat_gene_list[[j]]$gene_name <- c("MRC1LC", "MRC1LD", "MRC1LE", "MRC1LB", "MRC1LA", "MRC2", "PLA2R1")
}
}
cat_title <- paste("Immune category", immune_cats[i], "gene expression")
cat_plot_path <- paste("figures/expression_line_plots/immune_cat_", gsub(" ", "_", gsub("/", "_", immune_cats[i])), ".png", sep = "")
cat_title <- gsub(" rec", " receptor", gsub("imm ", "immune ", cat_title))
plot_de_cat_genes(cat_gene_list, c(2,4,12,24,48,72), cat_title, fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 1, num_samples_logfc_thresh = 1,
cat_plot_path)
}
kegg_immune_categories <- c("path:gga04640", "path:gga04610", "path:gga04611", "path:gga04620", "path:gga04624", "path:gga04621",
"path:gga04622", "path:gga04623", "path:gga04625", "path:gga04650", "path:gga04612", "path:gga04660",
"path:gga04658", "path:gga04659", "path:gga04657", "path:gga04662", "path:gga04664", "path:gga04666",
"path:gga04670", "path:gga04672", "path:gga04062")
go_immune_categories <- get_child_nodes("GO:0002376")
i <- 0
immune_genes <- c()
while (i < length(go_immune_categories$child_go_id)) {
i <- i + 1
go_cat_list <- get_de_go_cat_genes(topgenes_chicken_list, go_immune_categories$child_go_id[i], egGO, egSYMBOL)
print(go_immune_categories$child_go_id[i])
print(go_cat_list[[1]])
immune_genes <- c(immune_genes, go_cat_list[[1]]$gene_name)
}
i <- 0
while (i < length(kegg_immune_categories)) {
i <- i + 1
kegg_cat_list <- get_de_kegg_cat_genes(topgenes_chicken_list,"gga", kegg_immune_categories[i], egSYMBOL)
immune_genes <- c(immune_genes, kegg_cat_list[[1]]$gene_name)
}
immune_genes <- c(immune_genes, immune_classified_genes$gene_name)
immune_genes <- unique(immune_genes)
m <- match(immune_genes, rownames(chicken_logfc_df))
m <- m[complete.cases(m)]
chicken_immune_gene_logfc_df <- chicken_logfc_df[m,]
m <- match(immune_genes, rownames(chicken_logfc_df_filt))
m <- m[complete.cases(m)]
chicken_immune_gene_logfc_df_filt <- chicken_logfc_df_filt[m,]
heatmap_path <- "figures/heatmaps/chicken_immune_genes_logfc.png"
png(heatmap_path, width = 1500, height = 2000, pointsize = 100)
aspectHeatmap(as.matrix(chicken_immune_gene_logfc_df), Colv = NA,
xlab = "Timepoints", main = "Chicken immune gene log fold change",
col = colorRampPalette(brewer.pal(9, "RdYlGn"))(500),
hExp = 5.5, wExp = 0.8)
dev.off()
heatmap_path <- "figures/heatmaps/chicken_immune_genes_logfc_filt.png"
png(heatmap_path, width = 1000, height = 1600, pointsize = 20)
aspectHeatmap(as.matrix(chicken_immune_gene_logfc_df_filt), Colv = NA,
xlab = "Timepoints", main = "Chicken immune gene log fold change",
col = colorRampPalette(brewer.pal(9, "RdYlGn"))(500),
hExp = 2.3)
dev.off()
# Eimeria GO and KEGG analysis
# Import the file containing GO annotations downloaded from ToxoDB and KEGG annotations found through the KEGG KAAS service
path_to_eimeria_go_file <- "data/eimeria_go_kegg_annotation/GenesByGoTerm_Summary.csv"
path_to_eimeria_kegg_file <- "data/eimeria_go_kegg_annotation/eimeria_kegg_annotation.tsv"
path_to_transcript_to_gene_file <- "data/reference_genomes/eimeria_transcript_to_gene.tsv"
eimeria_go_annotation <- read.delim(path_to_eimeria_go_file, sep = ",", check.names=FALSE, stringsAsFactors=FALSE)
eimeria_kegg_best_cat_list <- read.delim(path_to_eimeria_kegg_file, check.names=FALSE, stringsAsFactors=FALSE, header = FALSE)
eimeria_transcript_to_gene <- read.delim(path_to_transcript_to_gene_file, check.names=FALSE, stringsAsFactors=FALSE, header = FALSE)
# Create a new dataframe with seperate entries for each gene for each GO category it belongs to
eimeria_full_go <- as.data.frame(matrix(0,
ncol = ncol(eimeria_go_annotation),
nrow = nrow(eimeria_go_annotation)))
colnames(eimeria_full_go) <- colnames(eimeria_go_annotation)
i <- 0
j <- 1
len_eimeria_go <- dim(eimeria_go_annotation)[1]
while (i < len_eimeria_go) {
go_cats <- strsplit(eimeria_go_annotation$`Computed GO Process IDs`[i+1], ";")[[1]]
go_cats_description <- strsplit(eimeria_go_annotation$`Computed GO Processes`[i+1], ";")[[1]]
k <- 1
len_go_cats <- length(go_cats)
while (k <= len_go_cats) {
eimeria_full_go[j,] <- eimeria_go_annotation[i+1,]
eimeria_full_go[j,"Computed GO Process IDs"] <- go_cats[k]
eimeria_full_go[j,"Computed GO Processes"] <- go_cats_description[k]
k <- k + 1
j <- j + 1
}
i <- i + 1
}
eimeria_go_analysis <- function(topgenes_eimeria, eimeria_full_go, eimeria_go_cats, fdr_thresh, logfc_thresh, ont) {
# Function for computing gene membership in GO categories
FDR_significant_genes <- topgenes_eimeria$table[topgenes_eimeria$table$FDR < fdr_thresh,]
num_significant_genes <- c(dim(FDR_significant_genes[FDR_significant_genes$logFC > logfc_thresh,])[1],
dim(FDR_significant_genes[FDR_significant_genes$logFC < -logfc_thresh,])[1])
eimeria_go_results <- as.data.frame(matrix(0, ncol = 8, nrow = length(eimeria_go_cats)))
colnames(eimeria_go_results) <- c("GO_ID", "Term", "Ont", "N", "Up", "Down", "P.Up", "P.Down")
i <- 1
neg_logfc_thresh <- -logfc_thresh
for (eimeria_go_cat in eimeria_go_cats) {
genes_in_go <- eimeria_full_go[eimeria_full_go$`Computed GO Process IDs` == eimeria_go_cat,]
eimeria_go_cat_term <- genes_in_go[1,"Computed GO Processes"]
N <- dim(genes_in_go)[1]
m <- match(genes_in_go$`Gene ID`, topgenes_eimeria$table$locus_tag)
if (!is.na(m[1])) {
m <- m[complete.cases(m)]
topgenes_eimeria_go_cat <- topgenes_eimeria$table[m,]
topgenes_eimeria_go_cat <- topgenes_eimeria_go_cat[topgenes_eimeria_go_cat$FDR < fdr_thresh,]
if (dim(topgenes_eimeria_go_cat)[1] != 0) {
num_up_genes <- nrow(topgenes_eimeria_go_cat[topgenes_eimeria_go_cat$logFC >= logfc_thresh,])
num_down_genes <- nrow(topgenes_eimeria_go_cat[topgenes_eimeria_go_cat$logFC <= neg_logfc_thresh,])
} else {
num_up_genes <- 0
num_down_genes <- 0
}
} else {
num_up_genes <- 0
num_down_genes <- 0
}
x <- c(num_up_genes, num_down_genes)
n <- dim(topgenes_eimeria)[1] - N
k <- num_significant_genes
fisher_up <- fisher.test(matrix(c(x[1],k[1]-x[1],N-x[1],n-(k[1]-x[1])),nrow=2,ncol=2),alternative="greater")
fisher_down <- fisher.test(matrix(c(x[2],k[2]-x[2],N-x[2],n-(k[2]-x[2])),nrow=2,ncol=2),alternative="greater")
go_cat_results <- data.frame(eimeria_go_cat, eimeria_go_cat_term, ont, N, num_up_genes, num_down_genes,
fisher_up$p.value, fisher_down$p.value, stringsAsFactors = FALSE)
eimeria_go_results[i,] <- go_cat_results[1,]
i <- i + 1
}
rownames(eimeria_go_results) <- eimeria_go_results$GO_ID
eimeria_go_results <- eimeria_go_results[,-1]
return(eimeria_go_results)
}
# Get the number of genes that are up or down regulated in each GO category
eimeria_go_cats <- unique(eimeria_full_go$`Computed GO Process IDs`)
allgo_eimeria_list <- lapply(topgenes_eimeria_list,
function(x) eimeria_go_analysis(x, eimeria_full_go, eimeria_go_cats, fdr_threshold, fdr_threshold, "BP"))
# Preprocessing of KEGG data for the KEGG enrichment analaysis
genes_in_analysis <- topgenes_eimeria_list[[1]]$table$entrez_gene_id
m <- match(genes_in_analysis, eimeria_transcript_to_gene[,1])
transcripts_in_analysis <- eimeria_transcript_to_gene[m,]
m <- match(transcripts_in_analysis[,2], eimeria_kegg_best_cat_list[,1])
kegg_ids_in_analysis <- eimeria_kegg_best_cat_list[m,2]
eimeria_kegg_genes <- data.frame(transcripts_in_analysis, kegg_ids_in_analysis)
eimeria_kegg_genes <- eimeria_kegg_genes[eimeria_kegg_genes[,3] != "",]
eimeria_kegg_id_universe <- eimeria_kegg_best_cat_list[eimeria_kegg_best_cat_list[,2] != "",2]
gene_to_pathway <- keggLink("pathway", "ko")
pathway_to_term <- keggList("pathway")
m <- match(eimeria_kegg_genes[,3], substr(names(gene_to_pathway), 4, nchar(gene_to_pathway[1])))
eimeria_kegg_genes <- eimeria_kegg_genes[!is.na(m),]
gene_pathways <- gene_to_pathway[m[complete.cases(m)]]
m <- match(gene_pathways, names(pathway_to_term))
pathway_terms <- pathway_to_term[m]
eimeria_kegg_annotation <- data.frame(genes = eimeria_kegg_genes[,1], kegg_pathway = gene_pathways,
kegg_term = pathway_terms, stringsAsFactors = FALSE)
m <- match(eimeria_kegg_id_universe, substr(names(gene_to_pathway), 4, nchar(gene_to_pathway[1])))
gene_universe_pathways <- gene_to_pathway[m[complete.cases(m)]]
eimeria_kegg_cats <- unique(gene_universe_pathways)
eimeria_kegg_analysis <- function(topgenes_eimeria, eimeria_kegg_annotation, eimeria_kegg_cats,
eimeria_universe, fdr_thresh, logfc_thresh) {
# Function for computing gene membership in KEGG categories
# Uses KEGGREST to access data from the KEGG database
FDR_significant_genes <- topgenes_eimeria$table[topgenes_eimeria$table$FDR < fdr_thresh,]
num_significant_genes <- c(dim(FDR_significant_genes[FDR_significant_genes$logFC > logfc_thresh,])[1],
dim(FDR_significant_genes[FDR_significant_genes$logFC < -logfc_thresh,])[1])
eimeria_kegg_results <- as.data.frame(matrix(0, ncol = 7, nrow = length(eimeria_kegg_cats)))
colnames(eimeria_kegg_results) <- c("KEGG_ID", "Term", "N", "Up", "Down", "P.Up", "P.Down")
i <- 1
neg_logfc_thresh <- -logfc_thresh
for (eimeria_kegg_cat in eimeria_kegg_cats) {
genes_in_kegg <- eimeria_kegg_annotation[eimeria_kegg_annotation$kegg_pathway == eimeria_kegg_cat,]
eimeria_kegg_cat_term <- genes_in_kegg[1,"kegg_term"]
N <- length(eimeria_universe[eimeria_universe == eimeria_kegg_cat])
m <- match(genes_in_kegg$genes, topgenes_eimeria$table$entrez_gene_id)
if (!is.na(m[1])) {
m <- m[complete.cases(m)]
topgenes_eimeria_kegg_cat <- topgenes_eimeria$table[m,]
topgenes_eimeria_kegg_cat <- topgenes_eimeria_kegg_cat[topgenes_eimeria_kegg_cat$FDR < fdr_thresh,]
if (dim(topgenes_eimeria_kegg_cat)[1] != 0) {
num_up_genes <- nrow(topgenes_eimeria_kegg_cat[topgenes_eimeria_kegg_cat$logFC >= logfc_thresh,])
num_down_genes <- nrow(topgenes_eimeria_kegg_cat[topgenes_eimeria_kegg_cat$logFC <= neg_logfc_thresh,])
} else {
num_up_genes <- 0
num_down_genes <- 0
}
} else {
num_up_genes <- 0
num_down_genes <- 0
}
x <- c(num_up_genes, num_down_genes)
n <- dim(topgenes_eimeria)[1] - N
k <- num_significant_genes
fisher_up <- fisher.test(matrix(c(x[1],k[1]-x[1],N-x[1],n-(k[1]-x[1])),nrow=2,ncol=2),alternative="greater")
fisher_down <- fisher.test(matrix(c(x[2],k[2]-x[2],N-x[2],n-(k[2]-x[2])),nrow=2,ncol=2),alternative="greater")
kegg_cat_results <- data.frame(eimeria_kegg_cat, eimeria_kegg_cat_term, N, num_up_genes, num_down_genes,
fisher_up$p.value, fisher_down$p.value, stringsAsFactors = FALSE)
eimeria_kegg_results[i,] <- kegg_cat_results[1,]
i <- i + 1
}
rownames(eimeria_kegg_results) <- eimeria_kegg_results$KEGG_ID
eimeria_kegg_results <- eimeria_kegg_results[,-1]
return(eimeria_kegg_results)
}
allkegg_eimeria_list <- lapply(topgenes_eimeria_list,
function(x) eimeria_kegg_analysis(x, eimeria_kegg_annotation, eimeria_kegg_cats,
gene_universe_pathways, fdr_threshold, 1))
# Export the top 50 most significantly enriched GO categories and KEGG pathways
i <- 0
while (i < length(allgo_eimeria_list)) {
i <- i + 1
go_path <- paste("results/de_analysis/top_go_kegg_tables/top_go_eimeria_", timepoints[i], ".csv", sep = "")
kegg_path <- paste("results/de_analysis/top_go_kegg_tables/top_kegg_eimeria_", timepoints[i], ".csv", sep = "")
min_pval_go <- pmin(allgo_eimeria_list[[i]]$P.Up, allgo_eimeria_list[[i]]$P.Down)
min_pval_kegg <- pmin(allkegg_eimeria_list[[i]]$P.Up, allkegg_eimeria_list[[i]]$P.Down)
allgo_eimeria_list[[i]] <- allgo_eimeria_list[[i]][order(min_pval_go),]
allkegg_eimeria_list[[i]] <- allkegg_eimeria_list[[i]][order(min_pval_kegg),]
write.csv(allgo_eimeria_list[[i]][1:50,], go_path)
write.csv(allkegg_eimeria_list[[i]][1:50,], kegg_path)
}
# Immune related E. tenella genes are plotted here
immune_related_eimeria_gene <- "ETH_00030475"
cat_gene_ids <- immune_related_eimeria_gene
cat_gene_list <- lapply(topgenes_eimeria_list, function(x) x$table[match(cat_gene_ids, x$table$locus_tag),])
cat_gene_list <- lapply(cat_gene_list, function(x) {colnames(x) <- c("entrez_gene_id", "gene_name", "logFC", "logCPM", "F", "PValue", "FDR")
return(x)})
cat_title <- "Eimeria immune activating genes"
cat_plot_path <- "figures/expression_line_plots/eimeria_immune_activating_genes.png"
plot_de_cat_genes(cat_gene_list, c(2,4,12,24,48,72), cat_title, fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 1, num_samples_logfc_thresh = 1,
cat_plot_path)
# Look at what limited GO and KEGG category information is available on E. tenella
apoptosis_affecting_go <- get_child_nodes("GO:0052040")
apoptosis_affecting_go_eimeria <- allgo_eimeria_list[[1]][match(apoptosis_affecting_go$child_go_id, rownames(allgo_eimeria_list[[1]])),]
kegg_immune_categories_eimeria <- c("path:map04640", "path:map04610", "path:map04611", "path:map04620", "path:map04624",
"path:map04621", "path:map04622", "path:map04623", "path:map04625", "path:map04650",
"path:map04612", "path:map04660", "path:map04658", "path:map04659", "path:map04657",
"path:map04662", "path:map04664", "path:map04666", "path:map04670", "path:map04672",
"path:map04062")
m <- match(kegg_immune_categories_eimeria, rownames(allkegg_eimeria_list[[1]]))
m <- m[complete.cases(m)]
immune_related_kegg_eimeria_list <- lapply(allkegg_eimeria_list, function(x) x[m,])
# Make a line plot of the percentage of Eimeria reads at different time points
eimeria_perc_df <- data.frame(eimeria_perc = c(0.5169, 1.2126, 0.586, 1.744566667, 5.391266667, 2.809),
timepoints = c(2, 4, 12, 24, 48, 72))
png("figures/eimeria_sample_fraction.png", width = 1200, height = 800)
p <- ggplot(eimeria_perc_df, aes(x = timepoints, y = eimeria_perc)) +
geom_line(size = 1.5) +
geom_point(size = 5) +
coord_cartesian(xlim = c(0, 80)) +
scale_x_discrete(limits=eimeria_perc_df$timepoints) +
theme_bw() +
ggtitle("E. tenella average sample fraction") +
theme(plot.title = element_text(hjust = 0.5, size = 40),
axis.text = element_text(size = 20),
axis.title = element_text(size = 30)) +
xlab("Sample time points") + ylab("E tenella percentage")
print(p)
dev.off()
# Analyze Eimeria SAG genes
eimeria_product_df <- read.delim("data/reference_genomes/eimeria_gene_products.csv",
col.names = c("gene_name", "entrez_gene_id", "product"), stringsAsFactors = FALSE)
eimeria_SAG_genes <- eimeria_product_df[grep("sag", eimeria_product_df$product),]
eimeria_SAG_genes <- eimeria_SAG_genes[eimeria_SAG_genes$entrez_gene_id %in% topgenes_eimeria_list[[1]]$table$entrez_gene_id,]
eimeria_SAG_gene_ids <- eimeria_SAG_genes$entrez_gene_id
SAG_gene_list <- lapply(topgenes_eimeria_list, function(x) x$table[match(eimeria_SAG_gene_ids, x$table$entrez_gene_id),])
SAG_gene_list <- lapply(SAG_gene_list, function(x) {colnames(x) <- c("entrez_gene_id", "gene_name", "logFC", "logCPM", "F", "PValue", "FDR")
return(x)})
SAG_gene_list <- lapply(SAG_gene_list, function(x) {x$gene_name <- eimeria_SAG_genes$product
return(x)})
SAG_title <- "Eimeria SAG gene expression"
SAG_plot_path <- "figures/expression_line_plots/SAG_genes.png"
plot_de_cat_genes(SAG_gene_list, c(2,4,12,24,48,72), SAG_title, fdr_thresh = fdr_threshold,
logfc_thresh = logfc_threshold, num_samples_fdr_thresh = 1, num_samples_logfc_thresh = 1,
SAG_plot_path, plot_scale = c(-12.5,12.5))
